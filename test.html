<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Профориентационный тест</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
    <style>
        .question {
            background-color: #fff;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            font-size: 18px;
        }
        label {
            display: block;
            margin: 10px 0;
        }
        input[type="radio"] {
            margin-right: 10px;
        }
        #test-result {
            font-size: 22px;
            color: #003366;
            margin-top: 30px;
        }
        #programs-list .program-card {
            font-size: 16px;
        }
        canvas#instituteChart {
            margin-top: 50px;
            max-width: 100%;
            height: auto;
        }
        #programs-list {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding-top: 15px;
        }
        .program-card {
            min-width: 250px;
            flex: 1 1 calc(33.33% - 20px);
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-sizing: border-box;
            transition: transform 0.3s ease;
            font-size: 0.9rem;
        }
        .program-card:hover {
            transform: translateY(-5px);
        }
        .program-card h4 {
            font-size: 1.1rem;
            margin-top: 0;
            text-align: center;
        }
        .program-card p {
            font-size: 0.9rem;
            text-align: center;
        }
        .program-card ul {
            list-style-type: none;
            padding-left: 0;
            margin-top: 8px;
        }
        .program-card li {
            margin-bottom: 5px;
            font-size: 0.85rem;
        }
        .program-card a {
            color: #007bff;
            text-decoration: none;
        }
        .program-card a:hover {
            text-decoration: underline;
        }

        .custom-radio {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .custom-radio input[type="radio"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 50%;
            outline: none;
            transition: all 0.3s ease;
        }
        .custom-radio input[type="radio"]:checked {
            background-color: #007bff;
            border-color: #007bff;
        }
        .custom-radio input[type="radio"]:checked::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .controls button,
        .cta-button {
            font-size: 18px !important;
            padding: 14px 24px !important;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<!-- Шапка -->
<header class="header">
    <div class="container">
        <div class="logo">Карьера: Твой путь</div>
        <nav class="nav">
            <ul>
                <li><a href="index.html">На главную</a></li>
                <li><a href="about-test.html">О тесте</a></li>
                <li><a href="test.html">Тест</a></li>
                <li><a href="programs.html">Направления обучения</a></li>
                <li><a href="profile.html">Личный кабинет</a></li>
            </ul>
        </nav>
        <div class="user-menu">
            <span id="user-login"></span>
            <button id="logout-button">Выйти</button>
        </div>
    </div>
</header>

<!-- Блок с тестом -->
<section class="test-section">
    <div class="container">
        <h2 style="font-size: 2.5rem; margin-bottom: 20px;">Профориентационный тест</h2>
        <p style="font-size: 1.25rem; margin-bottom: 30px;">Ответьте на вопросы и узнайте, какое направление вам подходит.</p>
        <form id="advanced-test-form">
            <div id="questions-container"></div>
            <div class="controls" style="text-align: center;">
                <button type="button" id="prev-btn" disabled>← Предыдущие</button>
                <button type="button" id="next-btn">Следующие →</button>
                <button type="submit" id="submit-btn" style="display: none; margin-left: 10px;">Получить результат</button>
            </div>
        </form>

        <!-- Результат -->
        <div id="test-result" style="margin-top: 30px;"></div>

        <!-- Подходящие программы -->
        <section id="programs-section" style="display: none; margin-top: 40px;">
            <h3 style="font-size: 1.5rem; margin-bottom: 20px;">Подходящие направления обучения</h3>
            <div id="programs-list" style="display: flex; flex-wrap: wrap; gap: 20px;"></div>
        </section>

        <!-- График -->
        <div id="chart-section" style="margin-top: 60px; text-align: center; display: none;">
            <canvas id="instituteChart" width="800" height="400"></canvas>
        </div>
    </div>
</section>

<script src="js/auth.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const storedUser = localStorage.getItem('user');
    const userLoginSpan = document.getElementById('user-login');
    const logoutBtn = document.getElementById('logout-button');

    if (!storedUser && window.location.pathname.includes('profile')) {
        window.location.href = 'login.html';
        return;
    }

    // Отображаем логин
    if (storedUser) {
        const userData = JSON.parse(storedUser);
        userLoginSpan.textContent = `Добро пожаловать, ${userData.login}`;
    }

    // Выход
    logoutBtn.addEventListener('click', async () => {
        const res = await fetch('logout.php');
        if (res.ok) {
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }
    });

    // Логика теста
    const form = document.getElementById('advanced-test-form');
    const container = document.getElementById('questions-container');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const submitBtn = document.getElementById('submit-btn');
    const resultDiv = document.getElementById('test-result');
    const programsList = document.getElementById('programs-list');
    const programsSection = document.getElementById('programs-section');
    const chartSection = document.getElementById('chart-section');

    const questionsPerPage = 10;
    let currentPage = 0;

    const questions = [
        { text: "Интересует ли вас изучение физико-химических свойств различных материалов...", institute: "Политехнический институт" },
        { text: "Готовы ли вы к разработке технологических процессов получения...", institute: "Политехнический институт" },
        { text: "Хотели бы вы участвовать в проведении научных исследований...", institute: "Политехнический институт" },
        { text: "Интересует ли проектирование конструкционных материалов для промышленности?", institute: "Политехнический институт" },
        { text: "Готовы ли вы применять современные методы анализа и контроля качества материалов?", institute: "Политехнический институт" },
        { text: "Хотели бы вы проектировать здания и городские пространства?", institute: "Институт горного дела и строительства" },
        { text: "Интересует ли проектирование безопасных и эстетичных интерьеров?", institute: "Институт горного дела и строительства" },
        { text: "Готовы ли вы глубоко изучать строительные материалы и инженерные системы?", institute: "Институт горного дела и строительства" },
        { text: "Применяете ли вы 3D-моделирование и компьютерную графику?", institute: "Институт горного дела и строительства" },
        { text: "Адаптируете ли дизайн под нормативы и потребности заказчиков?", institute: "Институт горного дела и строительства" },
        { text: "Готовы ли вы сотрудничать с другими специалистами?", institute: "Институт горного дела и строительства" },
        { text: "Хотели бы вы участвовать в процессе строительства?", institute: "Институт горного дела и строительства" },
        { text: "Интересует ли вас изучение исторических стилей?", institute: "Институт горного дела и строительства" },
        { text: "Готовы ли вы решать практические задачи?", institute: "Институт горного дела и строительства" },
        { text: "Хотели бы вы создавать экологичные проектные решения?", institute: "Институт горного дела и строительства" },
        { text: "Хотели бы вы изучать методы математического моделирования?", institute: "Институт прикладной математики и компьютерных наук" },
        { text: "Интересует ли вас разработка алгоритмов и программного обеспечения?", institute: "Институт прикладной математики и компьютерных наук" },
        { text: "Готовы ли вы освоить современные технологии программирования?", institute: "Институт прикладной математики и компьютерных наук" },
        { text: "Хотели бы вы применять методы машинного обучения?", institute: "Институт прикладной математики и компьютерных наук" },
        { text: "Интересует ли вас анализ и обработка больших массивов данных?", institute: "Институт прикладной математики и компьютерных наук" },
        { text: "Готовы ли вы изучить методы оптимизации и принятия решений?", institute: "Институт прикладной математики и компьютерных наук" },
        { text: "Хотели бы вы участвовать в разработке информационных систем?", institute: "Институт прикладной математики и компьютерных наук" },
        { text: "Интересует ли вас математическое моделирование в экономике?", institute: "Институт прикладной математики и компьютерных наук" },
        { text: "Готовы ли вы освоить методы визуализации данных?", institute: "Институт прикладной математики и компьютерных наук" },
        { text: "Хотели бы вы применять методы криптографии и кибербезопасности?", institute: "Институт прикладной математики и компьютерных наук" },
        { text: "Интересует ли вас изучение принципов радиоэлектронных устройств...", institute: "Институт высокоточных систем им. Грязева" },
        { text: "Моделируете ли радиосхемы и компоненты...", institute: "Институт высокоточных систем им. Грязева" },
        { text: "Участвуете ли в разработке новых радиоустройств...", institute: "Институт высокоточных систем им. Грязева" },
        { text: "Исследуете ли помехоустойчивость радиосистем...", institute: "Институт высокоточных систем им. Грязева" },
        { text: "Выполняете ли расчеты характеристик устройств...", institute: "Институт высокоточных систем им. Грязева" },
        { text: "Хотели бы вы участвовать в настройке и сертификации систем...", institute: "Институт высокоточных систем им. Грязева" },
        { text: "Интересует ли вас разработка микропроцессорных систем...", institute: "Институт высокоточных систем им. Грязева" },
        { text: "Готовы ли вы к организации технического обслуживания...", institute: "Институт высокоточных систем им. Грязева" },
        { text: "Хотели бы вы заниматься технологиями производства компонентов...", institute: "Институт высокоточных систем им. Грязева" },
        { text: "Интересует ли вас управление радиоэлектронными системами...", institute: "Институт высокоточных систем им. Грязева" }
    ];

    const shuffledQuestions = [...questions].sort(() => Math.random() - 0.5);
    const answers = {};

    function renderQuestions(page) {
        container.innerHTML = '';
        const start = page * questionsPerPage;
        const end = start + questionsPerPage;
        const pageQuestions = shuffledQuestions.slice(start, end);

        pageQuestions.forEach((q, index) => {
            const qIndex = start + index;
            const idYes = `q-${qIndex}-yes`;
            const idNo = `q-${qIndex}-no`;

            const div = document.createElement('div');
            div.className = 'question';
            div.innerHTML = `
                <p><strong>${q.text}</strong></p>
                <label for="${idYes}"><input type="radio" name="q${qIndex}" id="${idYes}" value="1"> Да</label>
                <label for="${idNo}"><input type="radio" name="q${qIndex}" id="${idNo}" value="0"> Нет</label>
            `;
            container.appendChild(div);
        });

        prevBtn.disabled = (currentPage === 0);
        nextBtn.style.display = (end < shuffledQuestions.length) ? 'inline-block' : 'none';
        submitBtn.style.display = (end >= shuffledQuestions.length) ? 'inline-block' : 'none';
    }

    function saveCurrentAnswers() {
        const formData = new FormData(form);
        for (let i = 0; i < shuffledQuestions.length; i++) {
            const val = formData.get(`q${i}`);
            if (val !== undefined) answers[i] = val;
        }
    }

    prevBtn.addEventListener('click', () => {
        if (currentPage > 0) {
            saveCurrentAnswers();
            currentPage--;
            renderQuestions(currentPage);
        }
    });

    nextBtn.addEventListener('click', () => {
        saveCurrentAnswers();
        if (currentPage < Math.ceil(shuffledQuestions.length / questionsPerPage) - 1) {
            currentPage++;
            renderQuestions(currentPage);
        }
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        saveCurrentAnswers();

        const scores = {
            "Политехнический институт": 0,
            "Институт горного дела и строительства": 0,
            "Институт прикладной математики и компьютерных наук": 0,
            "Институт высокоточных систем им. Грязева": 0
        };

        Object.entries(answers).forEach(([index, value]) => {
            if (value === '1') {
                const inst = shuffledQuestions[index]?.institute;
                if (inst in scores) scores[inst]++;
            }
        });

        const totalScore = Object.values(scores).reduce((a, b) => a + b, 0);
        const percentageScores = {};
        for (let key in scores) {
            percentageScores[key] = ((scores[key] / totalScore) * 100).toFixed(1);
        }

        const theme = Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b, '');

        try {
            const response = await fetch('submit_test.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ answers, theme })
            });
            const result = await response.json();

            resultDiv.innerHTML = `<p><strong>Вам подходит:</strong> ${result.theme || 'не определено'}</p>`;
            programsList.innerHTML = '';

            result.programs.forEach(item => {
                const program = item.program;

                const card = document.createElement('div');
                card.className = 'program-card';

                let vacanciesHTML = '';
                for (let profession in item.vacancies_by_profession) {
                    const vacancies = item.vacancies_by_profession[profession];
                    vacanciesHTML += `<strong>${profession}</strong><ul>`;
                    if (vacancies.length > 0) {
                        vacancies.forEach(v => {
                            vacanciesHTML += `<li><a href="${v.url}" target="_blank">${v.title}, ${v.employer}, ${v.salary}</a></li>`;
                        });
                    } else {
                        vacanciesHTML += `<li>Нет вакансий</li>`;
                    }
                    vacanciesHTML += '</ul>';
                }

                card.innerHTML = `
                    <h4>${program.code} — ${program.name}</h4>
                    <p><strong>Подходящие профессии:</strong><br>${item.professions.join(' | ')}</p>
                    <hr>
                    <h5 style="margin-top: 10px; font-size: 1rem;">Вакансии по профессиям:</h5>
                    ${vacanciesHTML}
                `;
                programsList.appendChild(card);
            });

            programsSection.style.display = 'block';

            const ctx = document.getElementById('instituteChart').getContext('2d');

            // Удаляем предыдущую диаграмму корректно
            if (window.myChartInstance) {
                window.myChartInstance.destroy();
            }

            // Проверяем, чтобы все данные были числовыми
            const labels = Object.keys(percentageScores);
            const dataValues = Object.values(percentageScores).map(Number).filter(Boolean); // фильтруем NaN

            if (labels.length === 0 || dataValues.length === 0) {
                chartSection.style.display = 'none';
                console.warn("Недостаточно данных для отрисовки диаграммы");
                return;
            }

            window.myChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Процентное распределение',
                        data: dataValues,
                        backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: { size: 16 },
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: context => `${context.parsed} %`
                            }
                        }
                    }
                }
            });

            chartSection.style.display = 'block';

        } catch (err) {
            console.error("Ошибка:", err);
            resultDiv.innerHTML = `<p style="color:red;">Ошибка загрузки данных</p>`;
        }
    });

    renderQuestions(currentPage);
});
</script>
</body>
</html>