<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Профориентационный тест</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- Подключаем Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
    <style>
        .question {
            background-color: #fff;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            font-size: 18px;
        }
        label {
            display: block;
            margin: 10px 0;
        }
        input[type="radio"] {
            margin-right: 10px;
        }
        #test-result {
            font-size: 22px;
            color: #003366;
            margin-top: 30px;
        }
        #programs-list .program-card {
            font-size: 16px;
        }
    </style>
</head>
<body>
<!-- Шапка -->
<header class="header">
    <div class="container">
        <div class="logo">Карьера: Твой путь</div>
        <nav class="nav">
            <ul>
                <li><a href="index.html">На главную</a></li>
                <li><a href="about-test.html">О тесте</a></li>
                <li><a href="test.html">Тест</a></li>
                <li><a href="programs.html">Направления обучения</a></li>
                <li><a href="profile.html">Личный кабинет</a></li>
            </ul>
        </nav>
        <div class="user-menu">
            <span id="user-login"></span>
            <button id="logout-button">Выйти</button>
        </div>
    </div>
</header>

<!-- Блок с тестом -->
<section class="test-section">
    <div class="container">
        <h2 style="font-size: 2.5rem; margin-bottom: 20px;">Профориентационный тест</h2>
        <p style="font-size: 1.25rem; margin-bottom: 30px;">Ответьте на вопросы и узнайте, какое направление вам подходит.</p>
        <form id="advanced-test-form">
            <div id="questions-container"></div>
            <div class="controls" style="text-align: center;">
                <button type="button" id="prev-btn" disabled>← Предыдущие</button>
                <button type="button" id="next-btn">Следующие →</button>
                <button type="submit" id="submit-btn" style="display: none; margin-left: 10px;">Получить результат</button>
                <button type="button" id="restart-test" style="display: none; margin-left: 10px; background-color: #dc3545; color: white;">Пройти тест заново</button>
            </div>
        </form>
        <!-- Результат -->
        <div id="test-result" style="margin-top: 30px;"></div>

        <!-- Подходящие программы -->
        <section id="programs-section" style="display: none; margin-top: 40px;">
            <h3 style="font-size: 1.5rem; margin-bottom: 20px;">Подходящие направления обучения</h3>
            <div id="programs-list" style="display: flex; flex-wrap: wrap; gap: 20px;"></div>
        </section>

        <!-- График (теперь после карточек) -->
        <canvas id="institute-chart" width="400" height="300" style="margin-top: 40px; display: none;"></canvas>
    </div>
</section>

<script src="js/auth.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const storedUser = localStorage.getItem('user');
    const userLoginSpan = document.getElementById('user-login');
    const logoutBtn = document.getElementById('logout-button');
    if (!storedUser && window.location.pathname.includes('profile')) {
        window.location.href = 'login.html';
        return;
    }

    // Отображаем логин
    if (storedUser) {
        const userData = JSON.parse(storedUser);
        userLoginSpan.textContent = `Добро пожаловать, ${userData.login}`;
    }

    // Выход
    logoutBtn.addEventListener('click', async () => {
        const res = await fetch('logout.php');
        if (res.ok) {
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }
    });

    // Логика теста
    const form = document.getElementById('advanced-test-form');
    const container = document.getElementById('questions-container');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const submitBtn = document.getElementById('submit-btn');
    const restartBtn = document.getElementById('restart-test');
    const resultDiv = document.getElementById('test-result');
    const programsList = document.getElementById('programs-list');
    const programsSection = document.getElementById('programs-section');
    const questionsPerPage = 10;
    let currentPage = 0;
    let shuffledQuestions = [];
    let answers = {};
    const questions = [
        { text: "Интересует ли вас изучение физико-химических свойств различных материалов...", institute: "Политехнический институт" },
        { text: "Готовы ли вы к разработке технологических процессов получения...", institute: "Политехнический институт" },
        { text: "Хотели бы вы участвовать в проведении научных исследований...", institute: "Политехнический институт" },
        { text: "Интересует ли проектирование конструкционных материалов для промышленности?", institute: "Политехнический институт" },
        { text: "Готовы ли вы применять современные методы анализа и контроля качества материалов?", institute: "Политехнический институт" },
        { text: "Хотели бы вы проектировать здания и городские пространства?", institute: "Институт горного дела и строительства" },
        { text: "Интересует ли проектирование безопасных и эстетичных интерьеров?", institute: "Институт горного дела и строительства" },
        { text: "Готовы ли вы глубоко изучать строительные материалы и инженерные системы?", institute: "Институт горного дела и строительства" },
        { text: "Применяете ли вы 3D-моделирование и компьютерную графику?", institute: "Институт горного дела и строительства" },
        { text: "Адаптируете ли дизайн под нормативы и потребности заказчиков?", institute: "Институт горного дела и строительства" },
        { text: "Готовы ли вы сотрудничать с другими специалистами?", institute: "Институт горного дела и строительства" },
        { text: "Хотели бы вы участвовать в процессе строительства?", institute: "Институт горного дела и строительства" },
        { text: "Интересует ли вас изучение исторических стилей?", institute: "Институт горного дела и строительства" },
        { text: "Готовы ли вы решать практические задачи?", institute: "Институт горного дела и строительства" },
        { text: "Хотели бы вы создавать экологичные проектные решения?", institute: "Институт горного дела и строительства" },
        { text: "Готовы ли вы освоить современные технологии программирования?", institute: "Институт прикладной математики и компьютерных наук" },
        { text: "Хотели бы вы применять методы машинного обучения?", institute: "Институт прикладной математики и компьютерных наук" },
        { text: "Интересует ли вас анализ и обработка больших массивов данных?", institute: "Институт прикладной математики и компьютерных наук" },
        { text: "Готовы ли вы изучить методы оптимизации и принятия решений?", institute: "Институт прикладной математики и компьютерных наук" },
        { text: "Хотели бы вы участвовать в разработке информационных систем?", institute: "Институт прикладной математики и компьютерных наук" },
        { text: "Интересует ли вас математическое моделирование в экономике?", institute: "Институт прикладной математики и компьютерных наук" },
        { text: "Готовы ли вы освоить методы визуализации данных?", institute: "Институт прикладной математики и компьютерных наук" },
        { text: "Хотели бы вы применять методы криптографии и кибербезопасности?", institute: "Институт прикладной математики и компьютерных наук" },
        { text: "Интересует ли вас изучение принципов радиоэлектронных устройств...", institute: "Институт высокоточных систем им. Грязева" },
        { text: "Моделируете ли радиосхемы и компоненты...", institute: "Институт высокоточных систем им. Грязева" },
        { text: "Участвуете ли в разработке новых радиоустройств...", institute: "Институт высокоточных систем им. Грязева" },
        { text: "Исследуете ли помехоустойчивость радиосистем...", institute: "Институт высокоточных систем им. Грязева" },
        { text: "Выполняете ли расчеты характеристик устройств...", institute: "Институт высокоточных систем им. Грязева" },
        { text: "Хотели бы вы участвовать в настройке и сертификации систем...", institute: "Институт высокоточных систем им. Грязева" },
        { text: "Интересует ли вас разработка микропроцессорных систем...", institute: "Институт высокоточных систем им. Грязева" },
        { text: "Готовы ли вы к организации технического обслуживания...", institute: "Институт высокоточных систем им. Грязева" },
        { text: "Хотели бы вы заниматься технологиями производства компонентов...", institute: "Институт высокоточных систем им. Грязева" },
        { text: "Интересует ли вас управление радиоэлектронными системами...", institute: "Институт высокоточных систем им. Грязева" }
    ];

    function loadTestState() {
        const state = localStorage.getItem('testState');
        if (state) {
            const parsed = JSON.parse(state);
            shuffledQuestions = parsed.shuffledQuestions || [...questions].sort(() => Math.random() - 0.5);
            answers = parsed.answers || {};
            currentPage = parsed.currentPage || 0;
        } else {
            shuffledQuestions = [...questions].sort(() => Math.random() - 0.5);
            answers = {};
            currentPage = 0;
        }
    }

    function saveTestState() {
        localStorage.setItem('testState', JSON.stringify({
            shuffledQuestions,
            answers,
            currentPage
        }));
    }

    function resetTestState() {
        localStorage.removeItem('testState');
        shuffledQuestions = [...questions].sort(() => Math.random() - 0.5);
        answers = {};
        currentPage = 0;
        renderQuestions(currentPage);
        programsSection.style.display = 'none';
        resultDiv.innerHTML = '';
        programsList.innerHTML = '';
        document.getElementById("institute-chart").style.display = 'none'; // Скрыть график
    }

    function renderQuestions(page) {
        container.innerHTML = '';
        const start = page * questionsPerPage;
        const end = start + questionsPerPage;
        const pageQuestions = shuffledQuestions.slice(start, end);
        pageQuestions.forEach((q, index) => {
            const qIndex = start + index;
            const val = answers[qIndex];
            const div = document.createElement('div');
            div.className = 'question';
            div.innerHTML = `
                <p><strong>${q.text}</strong></p>
                <label><input type="radio" name="q${qIndex}" value="1" ${val === '1' ? 'checked' : ''}> Да</label>
                <label><input type="radio" name="q${qIndex}" value="0" ${val === '0' ? 'checked' : ''}> Нет</label>
            `;
            container.appendChild(div);
        });
        prevBtn.disabled = (currentPage === 0);
        nextBtn.style.display = (end < shuffledQuestions.length) ? 'inline-block' : 'none';
        submitBtn.style.display = (end >= shuffledQuestions.length) ? 'inline-block' : 'none';
        restartBtn.style.display = (end >= shuffledQuestions.length) ? 'inline-block' : 'none';
    }

    function saveCurrentAnswers() {
        const formData = new FormData(form);
        shuffledQuestions.forEach((_, index) => {
            const val = formData.get(`q${index}`);
            if (val !== null) {
                answers[index] = val;
            } else if (!(index in answers)) {
                answers[index] = ""; // помечаем как неотвеченный
            }
        });
        saveTestState();
    }

    // ==== События ====
    prevBtn.addEventListener('click', () => {
        saveCurrentAnswers();
        if (currentPage > 0) {
            currentPage--;
            renderQuestions(currentPage);
        }
    });

    nextBtn.addEventListener('click', () => {
        saveCurrentAnswers();
        if (currentPage < Math.ceil(shuffledQuestions.length / questionsPerPage) - 1) {
            currentPage++;
            renderQuestions(currentPage);
        }
    });

    restartBtn.addEventListener('click', () => {
        if (confirm("Вы уверены, что хотите начать тест заново?")) {
            resetTestState();
        }
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        saveCurrentAnswers();

        const scores = {
            "Политехнический институт": 0,
            "Институт горного дела и строительства": 0,
            "Институт прикладной математики и компьютерных наук": 0,
            "Институт высокоточных систем им. Грязева": 0
        };

        Object.entries(answers).forEach(([index, value]) => {
            if (value === '1') {
                const inst = shuffledQuestions[index]?.institute;
                if (inst in scores) scores[inst]++;
            }
        });

        const theme = Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b, '');

        try {
            const response = await fetch('submit_test.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ answers, theme, scores, questions: shuffledQuestions })
            });
            const result = await response.json();

            // Отображение результата
            resultDiv.innerHTML = `<p><strong>Вам подходит:</strong> ${result.theme || 'не определено'}</p>`;
            programsList.innerHTML = '';

            result.programs.forEach(item => {
                const card = document.createElement('div');
                card.className = 'program-card';
                let vacanciesHTML = '';
                for (let profession in item.vacancies_by_profession) {
                    const vacancies = item.vacancies_by_profession[profession];
                    vacanciesHTML += `<strong>${profession}</strong><ul>`;
                    if (vacancies.length > 0) {
                        vacancies.forEach(v => {
                            vacanciesHTML += `<li><a href="${v.url}" target="_blank">${v.title}, ${v.employer}, ${v.salary}</a></li>`;
                        });
                    } else {
                        vacanciesHTML += `<li>Нет вакансий</li>`;
                    }
                    vacanciesHTML += '</ul>';
                }
                card.innerHTML = `
                    <h4>${item.program.code} — ${item.program.name}</h4>
                    <p><strong>Подходящие профессии:</strong><br>${item.professions.join(' | ')}</p>
                    <hr>
                    <h5 style="margin-top: 10px; font-size: 1rem;">Вакансии по профессиям:</h5>
                    ${vacanciesHTML}
                `;
                programsList.appendChild(card);
            });

            programsSection.style.display = 'block';

            // Показываем и рисуем график
            document.getElementById("institute-chart").style.display = 'block';

            const chartLabels = Object.keys(scores);
            const chartData = Object.values(scores);

            // Удаляем предыдущий график
            Chart.getChart("institute-chart")?.destroy();

            const ctx = document.getElementById('institute-chart').getContext('2d');

            const total = chartData.reduce((sum, val) => sum + val, 0);
            const percentages = chartData.map(val => ((val / total) * 100).toFixed(1));

            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: chartLabels.map((label, i) => `${label} (${percentages[i]}%)`),
                    datasets: [{
                        label: 'Распределение ответов',
                        data: chartData,
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 206, 86, 0.7)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 206, 86, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    let value = context.parsed || 0;
                                    let percent = ((value / total) * 100).toFixed(1);
                                    return ` ${label}: ${value} (${percent}%)`;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Распределение ваших ответов по институтам'
                        }
                    }
                }
            });

        } catch (err) {
            console.error("Ошибка:", err);
            resultDiv.innerHTML = `<p style="color:red;">Ошибка загрузки данных</p>`;
        }
    });

    loadTestState();
    renderQuestions(currentPage);
});
</script>
</body>
</html>