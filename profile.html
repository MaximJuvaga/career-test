<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Личный кабинет</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>

<!-- Шапка -->
<header class="header">
    <div class="container">
        <div class="logo">Карьера: Твой путь</div>
        <nav class="nav">
            <ul>
                <li><a href="index.html">На главную</a></li>
                <li><a href="about-test.html">О тесте</a></li>
                <li><a href="test.html">Пройти тест</a></li>
            </ul>
        </nav>
        <div class="user-menu">
            <span id="user-login"></span>
            <button id="logout-button">Выйти</button>
        </div>
    </div>
</header>

<!-- Блок профиля -->
<section class="profile-section">
    <div class="container">
        <h2 id="profile-title">Личный кабинет</h2>
        <div id="user-info">
            <!-- Здесь будет информация о пользователе -->
        </div>
        <div id="test-results">
            <!-- Здесь будут результаты теста -->
        </div>
    </div>
</section>

<!-- Подвал -->
<footer class="footer">
    <div class="container">
        <p>&copy; 2025 Карьера: Твой путь. Все права защищены.</p>
        <a href="#">Политика конфиденциальности</a>
        <a href="#">Пользовательское соглашение</a>
    </div>
</footer>

<script src="js/auth.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const userLoginSpan = document.getElementById('user-login');
    const logoutBtn = document.getElementById('logout-button');

    // Проверяем localStorage
    const storedUser = localStorage.getItem('user');
    if (!storedUser) {
        window.location.href = 'login.html';
        return;
    }

    const userData = JSON.parse(storedUser);
    userLoginSpan.textContent = `Добро пожаловать, ${userData.login}`;

    // Обработчик выхода
    logoutBtn.addEventListener('click', async () => {
        const response = await fetch('logout.php');
        if (response.ok) {
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }
    });

    // Загружаем данные пользователя
    try {
        const response = await fetch('get_user_data.php');
        const data = await response.json();

        if (data.error) throw new Error("Ошибка сервера");

        document.getElementById('user-info').innerHTML = `
            <p><strong>Логин:</strong> ${data.login}</p>
            <p><strong>Роль:</strong> ${data.role === 'abiturient' ? 'Абитуриент' : 'Преподаватель'}</p>
        `;

        // Если абитуриент — загружаем его результаты
        if (data.role === 'abiturient') {
            const resultsResponse = await fetch(`get_test_results.php?user_id=${data.id}`);
            const resultsData = await resultsResponse.json();

            if (resultsData.length === 0) {
                document.getElementById('test-results').innerHTML = '<p>Вы ещё не проходили тест.</p>';
            } else {
                let html = '<h3>Ваши результаты тестов:</h3>';
                resultsData.forEach(r => {
                    const parsedResult = JSON.parse(r.result_json);
                    html += `<div><p><strong>Тема:</strong> ${parsedResult.theme || 'Не определено'}</p>`;
                    html += `<p><strong>Дата:</strong> ${r.created_at}</p></div>`;
                });
                document.getElementById('test-results').innerHTML = html;
            }
        }

        // Если преподаватель — загружаем все результаты
        if (data.role === 'teacher') {
            const allResultsResponse = await fetch('get_all_test_results.php');
            const allResults = await allResultsResponse.json();

            if (allResults.length === 0) {
                document.getElementById('test-results').innerHTML = '<p>Нет результатов тестов</p>';
            } else {
                let html = '<h3>Все результаты тестов:</h3>';
                allResults.forEach(r => {
                    const parsedResult = JSON.parse(r.result_json);
                    html += `<div><p><strong>ID:</strong> ${r.user_id}</p>`;
                    html += `<p><strong>Тема:</strong> ${parsedResult.theme || 'Не определено'}</p>`;
                    html += `<p><strong>Дата:</strong> ${r.created_at}</p></div>`;
                });
                document.getElementById('test-results').innerHTML = html;
            }
        }

    } catch (error) {
        console.error("Ошибка:", error);
        localStorage.removeItem('user');
        window.location.href = 'login.html';
    }
});
</script>

</body>
</html>